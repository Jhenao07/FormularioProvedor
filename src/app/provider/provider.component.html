<div class="provider-page">
  <div class="provider-wrapper">

    <header class="provider-header">
      <img src="assets/nuvant.png" alt="Nuvant" />
    </header>

    <nav class="steps">
      <div *ngIf="countrySelected !== 'Otro'" class="step" [class.active]="currentStep === 1">
        1. Documentos
      </div>
      <div class="step" [class.active]="currentStep === 2">
        {{ countrySelected === 'Otro' ? '1.' : '2.' }} Información
      </div>
      <div class="step" [class.active]="currentStep === 3">
        {{ countrySelected === 'Otro' ? '2.' : '3.' }} Revisión
      </div>
    </nav>

    <section class="provider-card" [formGroup]="form">

      <div *ngIf="currentStep === 1 && countrySelected !== 'Otro'" [formGroup]="form" class="step-content">
        <div formGroupName="step2_docs">
          <h2>Documentos para {{ countrySelected }}</h2>
          <p style="color: var(--muted); margin-bottom: 24px; font-size: 14px;">
            Sube los archivos necesarios para validar tu cuenta.
          </p>

          <div class="option-list">
            @for(doc of arrayItems(); track doc.key) {
              <div class="doc-item" [class.has-file]="form.get('step2_docs.' + doc.key)?.value">
                <div class="doc-info">
                  <strong>{{ doc.title }}</strong>
                  <span *ngIf="form.get('step2_docs.' + doc.key)?.value" class="file-status-text">
                    ✅ {{ form.get('step2_docs.' + doc.key)?.value.name }}
                  </span>
                </div>

                <div class="doc-actions">
                  <label *ngIf="!form.get('step2_docs.' + doc.key)?.value"
                         [for]="'file-' + doc.key"
                         class="btn-secondary btn-sm">
                    Adjuntar
                  </label>

                  <ng-container *ngIf="form.get('step2_docs.' + doc.key)?.value">
                    <button type="button" class="btn-remove" (click)="removeFile(doc.key)" title="Eliminar">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                    </button>

                    <button type="button" class="btn-ai-sm" (click)="procesarPdf(doc.key)">
                      ✨ Procesar
                    </button>
                  </ng-container>

                  <input [id]="'file-' + doc.key"
                         type="file"
                         class="input-file-hidden"
                         (change)="onFileSelected($event, doc.key)" />
                </div>
              </div>
            }
          </div>

          <div class="actions" style="justify-content: flex-end;">
            <button type="button" class="btn-primary" [disabled]="form.get('step2_docs')?.invalid" (click)="goToStep(2)">
              Siguiente
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="currentStep === 2" [formGroup]="form" class="step-content">
        <div formGroupName="step2">
          <h2 class="title">Identificación del proveedor</h2>

          <div class="tabs">
            <button type="button" class="tab" [class.active]="providerType === 'juridica'" (click)="providerType='juridica'">
              Persona Jurídica
            </button>
            <button type="button" class="tab" [class.active]="providerType === 'natural'" (click)="providerType='natural'">
              Persona Natural
            </button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="label">Razón Social <span class="req">*</span></label>
              <div class="input-with-badge">
                <input type="text" formControlName="businessName" placeholder="Nombre completo" />
                <span class="badge-auto" *ngIf="form.get('step2.businessName')?.value">Autocompletado</span>
              </div>
            </div>

            <div class="form-group">
              <label class="label">NIT / Documento <span class="req">*</span></label>
              <div class="input-with-badge">
                <input type="text" formControlName="nit" placeholder="Escribe el NIT" />
                <span class="badge-auto" *ngIf="form.get('step2.nit')?.value">Autocompletado</span>
              </div>
            </div>

            <div class="form-group">
              <label class="label">Representante Legal <span class="req">*</span></label>
              <div class="input-with-badge">
                <input type="text" formControlName="legalRepName" placeholder="Nombre completo" />
                <span class="badge-auto" *ngIf="form.get('step2.legalRepName')?.value">Autocompletado</span>
              </div>
            </div>

            <div class="form-group full">
              <label class="label">¿Cuenta con sistema de gestión de riesgo?</label>
              <div class="radio-row">
                <label class="radio-label">
                  <input type="radio" formControlName="riskOption" value="SI" />
                  <span>Sí</span>
                </label>
                <label class="radio-label">
                  <input type="radio" formControlName="riskOption" value="NO" />
                  <span>No</span>
                </label>
              </div>
            </div>
          </div>

          <div class="actions">
            <button *ngIf="countrySelected !== 'Otro'" type="button" class="btn-secondary" (click)="prevStep()">Atrás</button>
            <button type="button" class="btn-primary" (click)="goToStep(3)" [disabled]="form.get('step2')?.invalid">
              Siguiente
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="currentStep === 3" class="step-content">
        <h2>Revisión y envío</h2>
        <div class="review-card">
          <p>País: <strong>{{ countrySelected }}</strong></p>
          <p>Razón Social: {{ form.get('step2.businessName')?.value }}</p>
        </div>
        <div class="actions">
          <button type="button" class="btn-secondary" (click)="prevStep()">Atrás</button>
          <button type="button" class="btn-primary" (click)="submitForm()">Finalizar Registro</button>
        </div>
      </div>

    </section>
  </div>

  <div *ngIf="toastMessage()" class="toast-notification fade-in-up">
    ⚠️ {{ toastMessage() }}
  </div>
</div>

<app-progress-overlay
  [open]="overlayOpen"
  [title]="overlayTitle"
  [subtitle]="overlaySubtitle"
  (close)="onOverlayClose()">
</app-progress-overlay>
